const express = require('express');
const cors = require('cors');
const path = require('path');
const { Resend } = require('resend');

// =============================================
// CONFIGURACI√ìN DESDE VARIABLES DE ENTORNO
// =============================================
const RESEND_API_KEY = process.env.RESEND_API_KEY;
const EMAIL_FROM = process.env.EMAIL_FROM || 'UCI Ambulancias <onboarding@resend.dev>';
const EMAIL_TO = process.env.EMAIL_TO || 'uciambulancias176@gmail.com';
const EMAIL_REPLY_TO = process.env.EMAIL_REPLY_TO || 'uciambulancias176@gmail.com';
const PORT = process.env.PORT || 3001;

// =============================================
// VALIDACI√ìN CR√çTICA AL INICIO
// =============================================
console.log('üîß INICIANDO CONFIGURACI√ìN...');
console.log('   - RESEND_API_KEY:', RESEND_API_KEY ? '‚úÖ CONFIGURADA' : '‚ùå FALTANTE');
console.log('   - EMAIL_FROM:', EMAIL_FROM);
console.log('   - EMAIL_TO:', EMAIL_TO);
console.log('   - EMAIL_REPLY_TO:', EMAIL_REPLY_TO);

if (!RESEND_API_KEY) {
    console.error('‚ùå ERROR CR√çTICO: FALTA RESEND_API_KEY en las variables de entorno');
    console.error('üí° Configura RESEND_API_KEY en las variables de entorno de Render');
    process.exit(1);
}

// =============================================
// INICIALIZACI√ìN DE EXPRESS Y RESEND
// =============================================
const app = express();
const resend = new Resend(RESEND_API_KEY);

console.log('‚úÖ Resend inicializado correctamente');

// =============================================
// MIDDLEWARES
// =============================================
app.use(cors({
  origin: [
    'https://uciambulancias.cl',
    'http://uciambulancias.cl',
    'https://www.uciambulancias.cl',
    'http://www.uciambulancias.cl',
    'http://localhost:3000',
    'http://127.0.0.1:3000',
    'file://'
  ],
  credentials: true,
  methods: ['GET', 'POST', 'PUT', 'DELETE'],
  allowedHeaders: ['Content-Type', 'Authorization']
}));

app.use(express.json({ limit: '50mb' }));
app.use(express.urlencoded({ extended: true, limit: '50mb' }));

// =============================================
// MENSAJE DE INICIO
// =============================================
console.log('üöÄ ============================================');
console.log('üè• UCI AMBULANCIAS - SISTEMA INICIADO');
console.log('üì° Servidor:', `https://uci-ambulancias-backend.onrender.com`);
console.log('üåç Dominios permitidos: uciambulancias.cl');
console.log('üìß Correo destino:', EMAIL_TO);
console.log('üîë API Key:', '‚úÖ CONFIGURADA');
console.log('üí° Estado: LISTO PARA RECIBIR FICHAS DESDE UCIAMBULANCIAS.CL');
console.log('üöÄ ============================================');

// =============================================
// RUTAS B√ÅSICAS
// =============================================

// Ruta principal
app.get('/', (req, res) => {
    res.json({
        message: 'üöë UCI Ambulancias - Backend Funcionando',
        version: '1.0.0',
        status: 'operational',
        endpoints: {
            fichaClinica: 'POST /ficha-clinica',
            status: 'GET /status',
            health: 'GET /health'
        },
        allowedOrigins: [
            'https://uciambulancias.cl',
            'http://uciambulancias.cl'
        ]
    });
});

// Health check - CORREGIDO
app.get('/health', (req, res) => {
    res.status(200).json({
        status: 'OK',
        service: 'UCI Ambulancias Backend',
        timestamp: new Date().toISOString(),
        environment: process.env.NODE_ENV || 'development',
        domain: 'uciambulancias.cl'
    });
});

// Status del servicio
app.get('/status', (req, res) => {
    res.json({
        status: 'operational',
        service: 'UCI Ambulancias PDF Service',
        resend: 'configured',
        email: EMAIL_TO,
        domain: 'uciambulancias.cl',
        timestamp: new Date().toISOString()
    });
});

// =============================================
// RUTA PRINCIPAL - ENV√çO DE FICHAS CL√çNICAS
// =============================================
app.post('/ficha-clinica', async (req, res) => {
    console.log('üì® SOLICITUD RECIBIDA - FICHA CL√çNICA');
    console.log('   - Origen:', req.get('origin'));
    console.log('   - Hora:', new Date().toISOString());
    
    try {
        const { paciente, folio, pdfBase64, tama√±oPDF, ambulancia } = req.body;

        // LOG DETALLADO
        console.log('üìä DATOS RECIBIDOS:');
        console.log('   - Paciente:', paciente);
        console.log('   - Folio:', folio);
        console.log('   - Tama√±o PDF:', tama√±oPDF);
        console.log('   - Ambulancia:', ambulancia);
        console.log('   - Longitud Base64:', pdfBase64 ? pdfBase64.length : 0);

        // VALIDACIONES B√ÅSICAS
        if (!paciente) {
            console.error('‚ùå FALTA NOMBRE DEL PACIENTE');
            return res.status(400).json({
                success: false,
                error: 'Falta el nombre del paciente',
                campo: 'paciente'
            });
        }

        if (!folio) {
            console.error('‚ùå FALTA FOLIO');
            return res.status(400).json({
                success: false,
                error: 'Falta el folio',
                campo: 'folio'
            });
        }

        if (!pdfBase64) {
            console.error('‚ùå FALTA PDF');
            return res.status(400).json({
                success: false,
                error: 'Falta el PDF en base64',
                campo: 'pdfBase64'
            });
        }

        // CONVERTIR PDF
        console.log('üîÑ CONVIRTIENDO PDF...');
        let pdfBuffer;
        try {
            const cleanBase64 = pdfBase64.replace(/^data:application\/pdf;base64,/, '');
            pdfBuffer = Buffer.from(cleanBase64, 'base64');
            console.log('‚úÖ PDF CONVERTIDO:', pdfBuffer.length + ' bytes');
        } catch (error) {
            console.error('‚ùå ERROR CONVIRTIENDO PDF:', error.message);
            return res.status(400).json({
                success: false,
                error: 'Error convirtiendo PDF',
                detalles: error.message
            });
        }

        // VALIDAR PDF
        if (pdfBuffer.length < 100) {
            console.error('‚ùå PDF DEMASIADO PEQUE√ëO:', pdfBuffer.length + ' bytes');
            return res.status(400).json({
                success: false,
                error: 'PDF inv√°lido o vac√≠o',
                tama√±o: pdfBuffer.length + ' bytes'
            });
        }

        // PREPARAR CORREO
        const attachments = [{
            filename: `FICHA_${folio}_${paciente.replace(/\s+/g, '_')}.pdf`,
            content: pdfBuffer
        }];

        console.log('üìß PREPARANDO CORREO...');
        console.log('   - Desde:', EMAIL_FROM);
        console.log('   - Hacia:', EMAIL_TO);
        console.log('   - Asunto:', `Ficha Cl√≠nica - ${paciente} - ${folio}`);

        // ENVIAR CORREO CON RESEND
        console.log('üöÄ ENVIANDO CORREO...');
        
        let emailData;
        let emailError;
        
        try {
            const result = await resend.emails.send({
                from: EMAIL_FROM,
                to: EMAIL_TO,
                reply_to: EMAIL_REPLY_TO,
                subject: `Ficha Cl√≠nica - ${paciente} - ${folio}`,
                html: `
                    <div style="font-family: Arial, sans-serif; padding: 20px;">
                        <h2 style="color: #2563eb;">üè• UCI Ambulancias</h2>
                        <h3>Nueva Ficha Cl√≠nica Recibida</h3>
                        <p><strong>Paciente:</strong> ${paciente}</p>
                        <p><strong>Folio:</strong> ${folio}</p>
                        <p><strong>Ambulancia:</strong> ${ambulancia || 'No especificada'}</p>
                        <p><strong>Fecha:</strong> ${new Date().toLocaleString('es-CL')}</p>
                        <p><strong>Tama√±o PDF:</strong> ${tama√±oPDF || Math.round(pdfBuffer.length / 1024) + ' KB'}</p>
                        <p><strong>Origen:</strong> ${req.get('origin') || 'Directo'}</p>
                        <hr>
                        <p><em>Sistema Autom√°tico UCI Ambulancias</em></p>
                    </div>
                `,
                attachments: attachments
            });

            emailData = result.data;
            emailError = result.error;
            
        } catch (sendError) {
            console.error('‚ùå ERROR ENVIANDO CORREO:', sendError);
            emailError = sendError;
        }

        if (emailError) {
            console.error('‚ùå ERROR RESEND:', emailError);
            return res.status(500).json({
                success: false,
                error: 'Error al enviar correo',
                detalles: emailError.message,
                tipo: 'RESEND_ERROR'
            });
        }

        // √âXITO
        console.log('üéâ CORREO ENVIADO EXITOSAMENTE!');
        console.log('   - Email ID:', emailData?.id);
        console.log('   - Paciente:', paciente);
        console.log('   - Folio:', folio);
        console.log('   - Hora:', new Date().toISOString());

        res.json({
            success: true,
            message: 'Ficha cl√≠nica enviada exitosamente',
            emailId: emailData?.id,
            paciente: paciente,
            folio: folio,
            ambulancia: ambulancia,
            timestamp: new Date().toISOString()
        });

    } catch (error) {
        console.error('üí• ERROR GENERAL EN FICHA-CLINICA:', error);
        res.status(500).json({
            success: false,
            error: 'Error interno del servidor',
            detalles: error.message,
            endpoint: '/ficha-clinica'
        });
    }
});

// =============================================
// RUTAS ADICIONALES
// =============================================

// Redirigir a la p√°gina real
app.get('/ficha-clinica', (req, res) => {
    res.redirect('https://uciambulancias.cl/ficha-clinica.html');
});

// Ruta de prueba
app.get('/test-form', (req, res) => {
    res.send(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>Test Form - UCI Ambulancias</title>
        </head>
        <body>
            <h1>üè• Test Form - UCI Ambulancias</h1>
            <p>Backend funcionando correctamente para uciambulancias.cl</p>
            <p>Puedes enviar fichas desde: https://uciambulancias.cl/ficha-clinica.html</p>
        </body>
        </html>
    `);
});

// =============================================
// MANEJO DE ERRORES
// =============================================

// Ruta no encontrada
app.use('*', (req, res) => {
    res.status(404).json({
        success: false,
        error: 'Ruta no encontrada',
        message: `La ruta ${req.originalUrl} no existe`,
        availableEndpoints: {
            home: 'GET /',
            health: 'GET /health',
            status: 'GET /status',
            fichaClinica: 'POST /ficha-clinica',
            test: 'GET /test-form'
        }
    });
});

// Manejo de errores general
app.use((err, req, res, next) => {
    console.error('üí• ERROR NO MANEJADO:', err);
    res.status(500).json({
        success: false,
        error: 'Error interno del servidor',
        message: err.message
    });
});

// =============================================
// INICIAR SERVIDOR
// =============================================
app.listen(PORT, () => {
    console.log(`\nüîó URLs disponibles:`);
    console.log(`   üè† https://uci-ambulancias-backend.onrender.com`);
    console.log(`   üìã https://uci-ambulancias-backend.onrender.com/ficha-clinica`);
    console.log(`   ‚úÖ https://uci-ambulancias-backend.onrender.com/status`);
    console.log(`   ‚ù§Ô∏è  https://uci-ambulancias-backend.onrender.com/health`);
    console.log(`   üß™ https://uci-ambulancias-backend.onrender.com/test-form`);
    console.log(`\nüåç Aceptando solicitudes desde: uciambulancias.cl`);
    console.log(`üöë Servidor UCI Ambulancias ejecut√°ndose en puerto ${PORT}`);
    console.log(`‚è∞ Iniciado a las: ${new Date().toISOString()}\n`);
});

module.exports = app;

