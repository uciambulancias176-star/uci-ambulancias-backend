const express = require('express');
const cors = require('cors');
const path = require('path');
const fs = require('fs');
const { Resend } = require('resend');

// Configuraci√≥n - En Render las variables vienen de process.env autom√°ticamente
const RESEND_API_KEY = process.env.RESEND_API_KEY;
const EMAIL_FROM = process.env.EMAIL_FROM || 'UCI Ambulancias <onboarding@resend.dev>';
const EMAIL_TO = process.env.EMAIL_TO || 'uciambulancias176@gmail.com';
const EMAIL_REPLY_TO = process.env.EMAIL_REPLY_TO || 'uciambulancias176@gmail.com';
const PORT = process.env.PORT || 3001;

const app = express();
const resend = new Resend(RESEND_API_KEY);

// Middlewares
app.use(cors());
app.use(express.json({ limit: process.env.PDF_MAX_SIZE || '50mb' }));
app.use(express.static('public'));

// Verificar configuraci√≥n al iniciar
console.log('üöÄ ============================================');
console.log('üè• UCI AMBULANCIAS - SISTEMA INICIADO');
console.log('üì° Servidor:', `http://localhost:${PORT}`);
console.log('üìß Correo destino:', EMAIL_TO);
console.log('üîë API Key:', RESEND_API_KEY ? '‚úÖ CONFIGURADA' : '‚ùå FALTANTE');
console.log('üí° Estado:', RESEND_API_KEY ? 'LISTO PARA ENVIAR FICHAS PDF' : 'CONFIGURACI√ìN INCOMPLETA');
console.log('üöÄ ============================================');

// Validar configuraci√≥n cr√≠tica
if (!RESEND_API_KEY) {
  console.error('‚ùå ERROR CR√çTICO: FALTA RESEND_API_KEY en las variables de entorno');
  process.exit(1);
}

// Rutas
app.get('/', (req, res) => {
  res.json({
    message: 'üöë UCI Ambulancias - Backend Funcionando',
    version: '1.0.0',
    status: 'operational',
    endpoints: {
      fichaClinica: '/ficha-clinica',
      status: '/status',
      health: '/health'
    }
  });
});

app.get('/health', (req, res) => {
  res.status(200).json({
    status: 'OK',
    service: 'UCI Ambulancias Backend',
    timestamp: new Date().toISOString(),
    environment: process.env.NODE_ENV || 'development'
  });
});

app.get('/status', (req, res) => {
  res.json({
    status: 'operational',
    service: 'UCI Ambulancias PDF Service',
    resend: RESEND_API_KEY ? 'configured' : 'missing',
    email: EMAIL_TO,
    timestamp: new Date().toISOString()
  });
});

// Ruta principal para enviar fichas cl√≠nicas
app.post('/ficha-clinica', async (req, res) => {
  try {
    const { paciente, folio, pdfBase64, tama√±oPDF } = req.body;

    console.log('üìä Datos recibidos:', { paciente, folio, 'tama√±oPDF': tama√±oPDF });

    // Validaciones
    if (!paciente || !folio || !pdfBase64) {
      return res.status(400).json({
        error: 'Datos incompletos',
        requeridos: ['paciente', 'folio', 'pdfBase64']
      });
    }

    // Convertir base64 a buffer
    console.log('üîÑ Convirtiendo PDF a buffer...');
    const pdfBuffer = Buffer.from(pdfBase64, 'base64');
    console.log('‚úÖ PDF convertido:', pdfBuffer.length, 'bytes');

    // Enviar correo
    console.log('üì§ Enviando correo a trav√©s de Resend...');
    
    const { data, error } = await resend.emails.send({
      from: EMAIL_FROM,
      to: EMAIL_TO,
      reply_to: EMAIL_REPLY_TO,
      subject: `Ficha Cl√≠nica - ${paciente} - ${folio}`,
      html: `
        <div style="font-family: Arial, sans-serif; padding: 20px;">
          <h2 style="color: #2563eb;">üè• UCI Ambulancias</h2>
          <h3>Nueva Ficha Cl√≠nica Recibida</h3>
          <p><strong>Paciente:</strong> ${paciente}</p>
          <p><strong>Folio:</strong> ${folio}</p>
          <p><strong>Fecha:</strong> ${new Date().toLocaleString()}</p>
          <p><strong>Tama√±o PDF:</strong> ${tama√±oPDF || Math.round(pdfBuffer.length / 1024) + ' KB'}</p>
          <hr>
          <p><em>Este es un env√≠o autom√°tico del sistema de UCI Ambulancias.</em></p>
        </div>
      `,
      attachments: [
        {
          filename: `ficha-clinica-${paciente}-${folio}.pdf`,
          content: pdfBuffer
        }
      ]
    });

    if (error) {
      console.error('‚ùå Error al enviar correo:', error);
      return res.status(500).json({
        error: 'Error al enviar correo',
        detalles: error.message
      });
    }

    console.log('‚úÖ CORREO ENVIADO EXITOSAMENTE!');
    console.log('üìß ID del correo:', data.id);
    console.log('üë§ Paciente:', paciente);
    console.log('üìÑ Folio:', folio);

    res.json({
      success: true,
      message: 'Ficha cl√≠nica enviada exitosamente',
      emailId: data.id,
      paciente: paciente,
      folio: folio,
      timestamp: new Date().toISOString()
    });

  } catch (error) {
    console.error('üí• Error en el servidor:', error);
    res.status(500).json({
      error: 'Error interno del servidor',
      detalles: error.message
    });
  }
});

// Ruta para servir el formulario HTML
app.get('/ficha-clinica', (req, res) => {
  res.sendFile(path.join(__dirname, 'ficha-clinica.html'));
});

// Manejo de errores
app.use((err, req, res, next) => {
  console.error('üí• Error no manejado:', err);
  res.status(500).json({
    error: 'Error interno del servidor',
    message: err.message
  });
});

// Ruta no encontrada
app.use('*', (req, res) => {
  res.status(404).json({
    error: 'Ruta no encontrada',
    message: `La ruta ${req.originalUrl} no existe`
  });
});

// Iniciar servidor
app.listen(PORT, () => {
  console.log(`\nüîó URLs disponibles:`);
  console.log(`   üìã http://localhost:${PORT}/ficha-clinica`);
  console.log(`   ‚úÖ http://localhost:${PORT}/status`);
  console.log(`   ‚ù§Ô∏è  http://localhost:${PORT}/health`);
  console.log(`\nüöë Servidor UCI Ambulancias ejecut√°ndose en puerto ${PORT}\n`);
});

module.exports = app;
