require('dotenv').config();
const express = require('express');
const cors = require('cors');
const path = require('path');
const { Resend } = require('resend');

const app = express();
const PORT = process.env.PORT || 3001;
const RESEND_API_KEY = process.env.RESEND_API_KEY;

// ==========================================
// CONFIGURACI√ìN
// ==========================================

// Validar API Key
if (!RESEND_API_KEY) {
    console.error('‚ùå ERROR CR√çTICO: FALTA RESEND_API_KEY en .env');
    console.log('üí° Verifica tu archivo .env tiene: RESEND_API_KEY=tu_api_key');
    process.exit(1);
}

// CONFIGURACI√ìN CORS - PRODUCCI√ìN (PEGAR)
app.use(cors({
    origin: [
        'https://uciambulancias.cl',
        'https://www.uciambulancias.cl'
    ],
    methods: ['GET', 'POST', 'OPTIONS'],
    allowedHeaders: ['Content-Type', 'Authorization', 'Accept'],
    credentials: false
}));

app.use(express.json({ limit: '50mb' }));
app.use(express.urlencoded({ extended: true, limit: '50mb' }));

// Servir archivos est√°ticos
app.use(express.static(path.join(__dirname)));

// ==========================================
// RUTAS PRINCIPALES
// ==========================================

// RUTA RAIZ - Ficha cl√≠nica
app.get('/', (req, res) => {
    console.log('üìÑ Sirviendo ficha cl√≠nica principal...');
    res.sendFile(path.join(__dirname, 'ficha-clinica.html'));
});

app.get('/ficha-clinica', (req, res) => {
    console.log('üè• Sirviendo formulario ficha cl√≠nica...');
    res.sendFile(path.join(__dirname, 'ficha-clinica.html'));
});

// ==========================================
// RUTA DE ENV√çO DE PDF - FUNCIONAL
// ==========================================

app.post('/enviar-correo', async (req, res) => {
    console.log('üöë [ENVIO] Iniciando env√≠o de ficha cl√≠nica...');
    
    try {
        const { pdf, paciente, folio, fecha, ambulancia, motivo } = req.body;

        console.log('üìä Datos recibidos:', {
            paciente: paciente || 'No especificado',
            folio: folio || 'No especificado',
            tama√±oPDF: pdf ? Math.round(pdf.length / 1024) + ' KB' : 'NO HAY PDF'
        });

        // VALIDACIONES CR√çTICAS
        if (!pdf) {
            console.log('‚ùå ERROR: No se recibi√≥ el PDF');
            return res.json({ 
                success: false, 
                error: 'ERROR: No se gener√≥ el PDF correctamente' 
            });
        }

        if (!paciente || paciente.trim() === '') {
            console.log('‚ùå ERROR: Falta nombre del paciente');
            return res.json({ 
                success: false, 
                error: 'ERROR: INGRESE NOMBRE DEL PACIENTE' 
            });
        }

        // CONFIGURACI√ìN RESEND
        const resend = new Resend(RESEND_API_KEY);

        // CONVERTIR PDF
        console.log('üîÑ Convirtiendo PDF a buffer...');
        const pdfBuffer = Buffer.from(pdf, 'base64');
        
        if (pdfBuffer.length === 0) {
            throw new Error('PDF vac√≠o o corrupto');
        }

        console.log(`‚úÖ PDF convertido: ${pdfBuffer.length} bytes`);

        // CONFIGURACI√ìN CORREO
        const emailConfig = {
            from: process.env.EMAIL_FROM || 'UCI Ambulancias <onboarding@resend.dev>',
            to: [process.env.EMAIL_TO || 'uciambulancias176@gmail.com'],
            replyTo: process.env.EMAIL_REPLY_TO || 'uciambulancias176@gmail.com',
            subject: `FICHA CL√çNICA ${folio} - ${paciente}`,
            html: `
                <div style="font-family: Arial, sans-serif; padding: 20px; max-width: 600px;">
                    <h2 style="color: #0074d9; border-bottom: 2px solid #0074d9; padding-bottom: 10px;">
                        üè• UCI AMBULANCIAS - Ficha Cl√≠nica
                    </h2>
                    
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 15px 0;">
                        <h3 style="color: #333; margin-top: 0;">üìã Datos del Traslado</h3>
                        <p><strong>üìÑ Folio:</strong> ${folio || 'No especificado'}</p>
                        <p><strong>üë§ Paciente:</strong> ${paciente}</p>
                        <p><strong>üìÖ Fecha:</strong> ${fecha || 'No especificada'}</p>
                        <p><strong>üöë Ambulancia:</strong> ${ambulancia || 'No especificada'}</p>
                        <p><strong>üéØ Motivo:</strong> ${motivo || 'No especificado'}</p>
                    </div>
                    
                    <div style="background: #e8f5e8; padding: 15px; border-radius: 5px; border-left: 4px solid #28a745;">
                        <p style="margin: 0; color: #2d5016;">
                            <strong>üìé ADJUNTO:</strong> Ficha cl√≠nica completa en formato PDF
                        </p>
                        <p style="margin: 5px 0 0 0; font-size: 14px;">
                            Incluye: Signos vitales, antecedentes, tratamientos, escalas m√©dicas y firmas
                        </p>
                    </div>
                    
                    <div style="margin-top: 20px; padding: 15px; background: #fff3cd; border-radius: 5px;">
                        <p style="margin: 0; color: #856404;">
                            <strong>‚ö° Generado autom√°ticamente</strong><br>
                            Sistema UCI Ambulancias - ${new Date().toLocaleDateString('es-CL')}
                        </p>
                    </div>
                </div>
            `,
            attachments: [{
                filename: `Ficha_Clinica_${folio || 'SN'}_${paciente.replace(/\s+/g, '_')}.pdf`,
                content: pdfBuffer,
                contentType: 'application/pdf'
            }]
        };

        // ENV√çO DE CORREO
        console.log('üì§ Enviando correo a trav√©s de Resend...');
        const { data, error } = await resend.emails.send(emailConfig);

        if (error) {
            console.error('‚ùå ERROR RESEND:', error);
            throw new Error(`Error Resend: ${error.message}`);
        }

        console.log('‚úÖ CORREO ENVIADO EXITOSAMENTE!');
        console.log('üìß ID del correo:', data.id);
        console.log('üë§ Paciente:', paciente);
        console.log('üìÑ Folio:', folio);

        // RESPUESTA DE √âXITO
        res.json({ 
            success: true, 
            message: '‚úÖ FICHA CL√çNICA ENVIADA CORRECTAMENTE A uciambulancias176@gmail.com',
            emailId: data.id,
            folio: folio,
            paciente: paciente,
            timestamp: new Date().toISOString()
        });

    } catch (error) {
        console.error('üí• ERROR CR√çTICO EN ENV√çO:', error);
        
        res.json({ 
            success: false, 
            error: `ERROR: ${error.message}`,
            timestamp: new Date().toISOString()
        });
    }
});

// ==========================================
// RUTAS DE DIAGN√ìSTICO
// ==========================================

app.get('/status', (req, res) => {
    res.json({ 
        status: '‚úÖ SERVIDOR FUNCIONANDO',
        servicio: 'UCI Ambulancias - Sistema de Fichas Cl√≠nicas',
        timestamp: new Date().toLocaleString('es-CL'),
        version: '1.0.0',
        configuracion: {
            puerto: PORT,
            apiKey: RESEND_API_KEY ? '‚úÖ CONFIGURADA' : '‚ùå FALTANTE',
            emailFrom: process.env.EMAIL_FROM,
            emailTo: process.env.EMAIL_TO
        }
    });
});

app.get('/health', (req, res) => {
    res.json({ 
        status: 'OK', 
        message: 'üöë Servidor UCI Ambulancias operativo',
        timestamp: new Date().toISOString()
    });
});

// ==========================================
// INICIALIZACI√ìN
// ==========================================

app.listen(PORT, () => {
    console.log('üöÄ ============================================');
    console.log('üè• UCI AMBULANCIAS - SISTEMA INICIADO');
    console.log(`üì° Servidor: http://localhost:${PORT}`);
    console.log(`üìß Correo destino: ${process.env.EMAIL_TO}`);
    console.log(`üîë API Key: ${RESEND_API_KEY ? '‚úÖ CONFIGURADA' : '‚ùå FALTANTE'}`);
    console.log('üí° Estado: LISTO PARA ENVIAR FICHAS PDF');
    console.log('üöÄ ============================================');
    console.log('\nüîó URLs disponibles:');
    console.log('   üìã http://localhost:3001/ficha-clinica');
    console.log('   ‚úÖ http://localhost:3001/status');
    console.log('   ‚ù§Ô∏è  http://localhost:3001/health');
});