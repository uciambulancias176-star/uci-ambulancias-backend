const express = require('express');
const cors = require('cors');
const path = require('path');
const { Resend } = require('resend');

// Configuraci√≥n desde variables de entorno
const RESEND_API_KEY = process.env.RESEND_API_KEY;
const EMAIL_FROM = process.env.EMAIL_FROM || 'UCI Ambulancias <onboarding@resend.dev>';
const EMAIL_TO = process.env.EMAIL_TO || 'uciambulancias176@gmail.com';
const EMAIL_REPLY_TO = process.env.EMAIL_REPLY_TO || 'uciambulancias176@gmail.com';
const PORT = process.env.PORT || 3001;

// Validar configuraci√≥n cr√≠tica al inicio
if (!RESEND_API_KEY) {
    console.error('‚ùå ERROR CR√çTICO: FALTA RESEND_API_KEY en las variables de entorno');
    console.error('üí° Configura RESEND_API_KEY en las variables de entorno de Render');
    process.exit(1);
}

const app = express();
const resend = new Resend(RESEND_API_KEY);

// Middlewares - CORS configurado para uciambulancias.cl
app.use(cors({
  origin: [
    'https://uciambulancias.cl',
    'http://uciambulancias.cl',
    'https://www.uciambulancias.cl',
    'http://www.uciambulancias.cl',
    'http://localhost:3000',
    'http://127.0.0.1:3000',
    'file://'
  ],
  credentials: true,
  methods: ['GET', 'POST', 'PUT', 'DELETE'],
  allowedHeaders: ['Content-Type', 'Authorization']
}));

app.use(express.json({ limit: process.env.PDF_MAX_SIZE || '50mb' }));
app.use(express.urlencoded({ extended: true, limit: '50mb' }));

// Mensaje de inicio
console.log('üöÄ ============================================');
console.log('üè• UCI AMBULANCIAS - SISTEMA INICIADO');
console.log('üì° Servidor:', `https://uci-ambulancias-backend.onrender.com`);
console.log('üåç Dominios permitidos: uciambulancias.cl');
console.log('üìß Correo destino:', EMAIL_TO);
console.log('üîë API Key:', '‚úÖ CONFIGURADA');
console.log('üí° Estado: LISTO PARA RECIBIR FICHAS DESDE UCIAMBULANCIAS.CL');
console.log('üöÄ ============================================');

// Rutas
app.get('/', (req, res) => {
    res.json({
        message: 'üöë UCI Ambulancias - Backend Funcionando',
        version: '1.0.0',
        status: 'operational',
        endpoints: {
            fichaClinica: 'POST /ficha-clinica',
            status: '/status',
            health: '/health'
        },
        allowedOrigins: [
            'https://uciambulancias.cl',
            'http://uciambulancias.cl'
        ]
    });
});

app.get('/health', (req, res) => {
    res.status(200).json({
        status: 'OK',
        service: 'UCI Ambulancias Backend',
        timestamp: new Date().toISOString(),
        environment: process.env.NODE_ENV || 'development',
        domain: 'uciambulancias.cl'
    });
});

app.get('/status', (req, res) => {
    res.json({
        status: 'operational',
        service: 'UCI Ambulancias PDF Service',
        resend: 'configured',
        email: EMAIL_TO,
        domain: 'uciambulancias.cl',
        timestamp: new Date().toISOString()
    });
});

// Ruta principal para enviar fichas cl√≠nicas DESDE uciambulancias.cl
app.post('/ficha-clinica', async (req, res) => {
    try {
        console.log('üì® Solicitud recibida desde:', req.get('origin'));
        
        const { paciente, folio, pdfBase64, tama√±oPDF, pdfData, data, fotos, firmas, ambulancia } = req.body;

        console.log('üìä Datos recibidos:', { 
            paciente, 
            folio, 
            'tama√±oPDF': tama√±oPDF,
            'tienePdfBase64': !!pdfBase64,
            'tienePdfData': !!pdfData,
            'tieneData': !!data,
            'fotos': fotos ? Object.keys(fotos).length : 0,
            'firmas': firmas ? Object.keys(firmas).length : 0,
            'ambulancia': ambulancia
        });

        // Validaciones flexibles para diferentes formatos
        let pdfBuffer;
        let pdfContent = pdfBase64 || pdfData || data;

        if (!paciente || !folio || !pdfContent) {
            return res.status(400).json({
                error: 'Datos incompletos',
                requeridos: ['paciente', 'folio', 'pdfBase64 o pdfData o data'],
                recibido: req.body
            });
        }

        // Convertir base64 a buffer
        console.log('üîÑ Convirtiendo PDF a buffer...');
        
        // Limpiar el base64 si viene con prefijo data:application/pdf;base64,
        const cleanBase64 = pdfContent.replace(/^data:application\/pdf;base64,/, '');
        
        pdfBuffer = Buffer.from(cleanBase64, 'base64');
        console.log('‚úÖ PDF convertido:', pdfBuffer.length, 'bytes');

        // Validar que sea un PDF v√°lido
        if (pdfBuffer.length < 100) {
            return res.status(400).json({
                error: 'PDF inv√°lido o vac√≠o',
                tama√±o: pdfBuffer.length + ' bytes'
            });
        }

        // PREPARAR ADJUNTOS - SOLO EL PDF (las fotos y firmas ya est√°n dentro del PDF)
        const attachments = [
            {
                filename: `FICHA_${folio}_${paciente}.pdf`,
                content: pdfBuffer
            }
        ];

        // LOG DE FOTOS Y FIRMAS (solo para informaci√≥n, no se adjuntan por separado)
        if (fotos && typeof fotos === 'object') {
            console.log('üì∏ Fotos incluidas en PDF:', Object.keys(fotos).length, 'secciones');
        }

        if (firmas && typeof firmas === 'object') {
            console.log('üñäÔ∏è Firmas incluidas en PDF:', Object.keys(firmas).length);
        }

        console.log(`üìé Adjunto preparado: 1 PDF con toda la informaci√≥n`);

        // Enviar correo
        console.log('üì§ Enviando correo a trav√©s de Resend...');
        
        const { data: emailData, error } = await resend.emails.send({
            from: EMAIL_FROM,
            to: EMAIL_TO,
            reply_to: EMAIL_REPLY_TO,
            subject: `Ficha Cl√≠nica - ${paciente} - ${folio}`,
            html: `
                <div style="font-family: Arial, sans-serif; padding: 20px;">
                    <h2 style="color: #2563eb;">üè• UCI Ambulancias</h2>
                    <h3>Nueva Ficha Cl√≠nica Recibida</h3>
                    <p><strong>Paciente:</strong> ${paciente}</p>
                    <p><strong>Folio:</strong> ${folio}</p>
                    <p><strong>Ambulancia:</strong> ${ambulancia || 'No especificada'}</p>
                    <p><strong>Fecha:</strong> ${new Date().toLocaleString()}</p>
                    <p><strong>Tama√±o PDF:</strong> ${tama√±oPDF || Math.round(pdfBuffer.length / 1024) + ' KB'}</p>
                    <p><strong>Contenido:</strong> PDF con fotos y firmas incluidas</p>
                    <p><strong>Fotos en PDF:</strong> ${fotos ? Object.keys(fotos).length : 0} secciones</p>
                    <p><strong>Firmas en PDF:</strong> ${firmas ? Object.keys(firmas).length : 0}</p>
                    <p><strong>Origen:</strong> ${req.get('origin') || 'Directo'}</p>
                    <hr>
                    <p><em>Este es un env√≠o autom√°tico del sistema de UCI Ambulancias.</em></p>
                </div>
            `,
            attachments: attachments
        });

        if (error) {
            console.error('‚ùå Error al enviar correo:', error);
            return res.status(500).json({
                error: 'Error al enviar correo',
                detalles: error.message
            });
        }

        console.log('‚úÖ CORREO ENVIADO EXITOSAMENTE!');
        console.log('üìß ID del correo:', emailData.id);
        console.log('üë§ Paciente:', paciente);
        console.log('üìÑ Folio:', folio);
        console.log('üöë Ambulancia:', ambulancia);
        console.log('üìé Archivo adjunto: 1 PDF con toda la informaci√≥n');
        console.log('üåç Origen:', req.get('origin'));

        res.json({
            success: true,
            message: 'Ficha cl√≠nica enviada exitosamente',
            emailId: emailData.id,
            paciente: paciente,
            folio: folio,
            ambulancia: ambulancia,
            archivosAdjuntos: 1,
            fotosEnPDF: fotos ? Object.keys(fotos).length : 0,
            firmasEnPDF: firmas ? Object.keys(firmas).length : 0,
            origen: req.get('origin'),
            timestamp: new Date().toISOString()
        });

    } catch (error) {
        console.error('üí• Error en el servidor:', error);
        res.status(500).json({
            error: 'Error interno del servidor',
            detalles: error.message,
            bodyRecibido: req.body
        });
    }
});

// Redirigir a la p√°gina real de uciambulancias.cl
app.get('/ficha-clinica', (req, res) => {
    res.redirect('https://uciambulancias.cl/ficha-clinica.html');
});

// Ruta de prueba para formularios HTML
app.get('/test-form', (req, res) => {
    res.send(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>Test Form - UCI Ambulancias</title>
        </head>
        <body>
            <h1>üè• Test Form - UCI Ambulancias</h1>
            <p>Backend funcionando correctamente para uciambulancias.cl</p>
            <p>Puedes enviar fichas desde: https://uciambulancias.cl/ficha-clinica.html</p>
        </body>
        </html>
    `);
});

// Manejo de errores
app.use((err, req, res, next) => {
    console.error('üí• Error no manejado:', err);
    res.status(500).json({
        error: 'Error interno del servidor',
        message: err.message
    });
});

// Ruta no encontrada
app.use('*', (req, res) => {
    res.status(404).json({
        error: 'Ruta no encontrada',
        message: `La ruta ${req.originalUrl} no existe`,
        availableEndpoints: {
            home: '/',
            health: '/health',
            status: '/status',
            fichaClinica: 'POST /ficha-clinica',
            test: '/test-form'
        }
    });
});

// Iniciar servidor
app.listen(PORT, () => {
    console.log(`\nüîó URLs disponibles:`);
    console.log(`   üè† https://uci-ambulancias-backend.onrender.com`);
    console.log(`   üìã https://uci-ambulancias-backend.onrender.com/ficha-clinica`);
    console.log(`   ‚úÖ https://uci-ambulancias-backend.onrender.com/status`);
    console.log(`   ‚ù§Ô∏è  https://uci-ambulancias-backend.onrender.com/health`);
    console.log(`   üß™ https://uci-ambulancias-backend.onrender.com/test-form`);
    console.log(`\nüåç Aceptando solicitudes desde: uciambulancias.cl`);
    console.log(`üöë Servidor UCI Ambulancias ejecut√°ndose en puerto ${PORT}\n`);
});

module.exports = app;

